# 重试策略（IRetryPolicy）使用说明

本文档介绍 `NewLife.Remoting` 中新增的可选重试能力，包括启用方式、接口约定与示例策略。

## 概述
- 目标：提升客户端在瞬时错误（网络抖动、短暂不可用等）下的健壮性。
- 默认行为：不启用重试（保持既有语义）。
- 生效条件：`ApiClient.RetryPolicy != null` 且 `ApiClient.MaxRetries > 0`。
- 特例：401（Unauthorized）仍采用既有行为――触发一次 `OnLoginAsync(force=true)` 后在同一连接上重发，不计入重试次数。

## 启用方式
```csharp
var client = new ApiClient("tcp://127.0.0.1:12345")
{
    RetryPolicy = new MyRetryPolicy(),
    MaxRetries = 3 // 不含首次尝试
};

var result = await client.InvokeAsync<string>("Hello/Say", new { Name = "Stone" });
```

- `RetryPolicy`：实现 `IRetryPolicy`，用于按异常类型与当前第几次重试，决定是否重试、等待多久、是否更换连接。
- `MaxRetries`：最大重试次数，不含首次尝试（0 表示禁用）。

## 策略接口
```csharp
public interface IRetryPolicy
{
    bool ShouldRetry(Exception exception, int attempt, out TimeSpan delay, out bool refreshClient);
}
```
- `exception`：本次失败的异常（可据此筛选 Transient）。
- `attempt`：当前重试序号（从 1 开始，不含首次）。
- `delay`：建议等待时长；`TimeSpan.Zero` 表示不等待立即重试。
- `refreshClient`：是否在重试前更换底层连接（`Cluster.Return` 之后再 `Cluster.Get`）。

## 示例策略：指数退避 + 连接可选切换
```csharp
public sealed class MyRetryPolicy : IRetryPolicy
{
    public bool ShouldRetry(Exception exception, int attempt, out TimeSpan delay, out bool refreshClient)
    {
        // 401 由框架层处理，不在策略内重试
        if (exception is ApiException aex && aex.Code == ApiCode.Unauthorized)
        {
            delay = TimeSpan.Zero;
            refreshClient = false;
            return false;
        }

        // 对于超时/网络异常等：最多退避 2^attempt * 100ms，最多 2 秒
        if (exception is TimeoutException || exception is TaskCanceledException || exception is IOException || exception is SocketException)
        {
            var ms = Math.Min(2000, (int)Math.Pow(2, attempt) * 100);
            delay = TimeSpan.FromMilliseconds(ms);
            // 第 2 次及以后尝试切换连接
            refreshClient = attempt >= 2;
            return true;
        }

        // 其它异常，不重试
        delay = TimeSpan.Zero;
        refreshClient = false;
        return false;
    }
}
```

## 行为细节
- 401 处理：框架捕获后调用 `OnLoginAsync(force=true)`，再在同一连接上重发一次，不计入 `MaxRetries`。
- 超时消息：重试最终仍失败或策略未触发时，`TaskCanceledException` 会被转为短消息：`"[action]超时[Timeout]取消"`，在日志级别 Debug 下包含更多上下文。
- 连接切换：当 `refreshClient=true` 时，当前连接将归还，重试前重新从 `Cluster` 获取。
- 取消支持：`InvokeAsync` 的 `CancellationToken` 将在等待 `delay` 时被观察，取消会立即中断重试并抛出。

## 建议与最佳实践
- 合理的 `MaxRetries`：2~3 次通常足够，避免重试风暴。
- 退避策略：使用线性/指数退避，避免密集重试。
- 连接切换：仅在确认连接层异常或连续失败后再切换。
- 观测：结合 `SlowTrace` 与日志，评估重试对端到端耗时的影响。

## 常见问题
- Q：启用重试后是否会改变正常业务语义？
  - A：不会。默认不启用；启用后只对策略判定的异常进行有限次重试。
- Q：与连接池/单连接模式是否兼容？
  - A：兼容。`refreshClient` 为 true 时在两种模式下都会归还并重新获取连接。
- Q：是否提供内置策略？
  - A：核心库不内置，避免行为争议；可在扩展库或业务侧提供通用策略。

## 参考
- `ApiClient.InvokeAsync<TResult>`：可选重试逻辑入口。
- `ApiClient.OnLoginAsync(...)`：401 登录后重发的钩子。
- `IRetryPolicy`：自定义重试策略接口。
